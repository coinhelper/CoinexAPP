/*
 * File: app/controller/currenciesController.js
 *
 * This file was generated by Sencha Architect version 3.0.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CoinEX.controller.currenciesController', {
    extend: 'Ext.app.Controller',

    stores: [
        'tradePairs',
        'currencies',
        'markets',
        'sellOrderBook',
        'buyOrderBook',
        'orderBook',
        'trades',
        'chartItems'
    ],

    refs: [
        {
            ref: 'comboBox',
            selector: 'combobox#market-select'
        },
        {
            ref: 'currenciesGrid',
            selector: '#currenciesgrid'
        }
    ],

    onComboboxSelect: function(combo, records, eOpts) {
        var market_id = combo.getValue(),
            store = this.getTradePairsStore();

        store.clearFilter(true);
        store.filter('market_id', market_id);
    },

    onComboboxAfterRender: function(component, eOpts) {
        var record = this.getMarketsStore().findRecord('name', 'BTC');

        this.getTradePairsStore().filter('market_id', record.get('id'));
        this.getComboBox().select(record);

    },

    onViewItemClick: function(dataview, record, item, index, e, eOpts) {
        var stores = [
                this.getOrderBookStore(),
                this.getTradesStore()
            ],
            params = {
                tradePair: record.get('id')
            };

        Ext.getCmp('sellordersgrid').setLoading(true);
        Ext.getCmp('buyordersgrid').setLoading(true);

        Ext.each(stores, function (store) {
            store.load({
                params: params
            });
        });


        var chartItemsStore = this.getChartItemsStore();

        chartItemsStore.getProxy().url = "/api/trade_pairs/" + record.get('id') + "/chart_items";
        chartItemsStore.load();
    },

    generateMarkets: function(market_ids) {
        var me = this,
            markets = me.getMarketsStore(),
            currencies = me.getCurrenciesStore();


        if (markets.count() !== 0) {
            markets.removeAll();
        }

        Ext.each(market_ids, function (market_id) {
            var currency = currencies.findRecord('id', market_id);
            markets.add({
                id:  market_id,
                name: currency.get('name')
            });
        });

        me.marketsLoaded = true;
    },

    onCurrenciesLoad: function() {
        this.getTradePairsStore().load();
    },

    onTradePairsLoad: function() {
        var me = this, store = me.getTradePairsStore();

        if (!me.marketsLoaded) {
            me.generateMarkets(store.collect('market_id'));
        }
    },

    reloadStore: function() {
        this.getTradePairsStore().reload();
    },

    init: function(application) {
                var me = this;

                me.getCurrenciesStore().on('load', me.onCurrenciesLoad, me);
                me.getTradePairsStore().on('load', me.onTradePairsLoad, me);

                me.getCurrenciesStore().load();

                if (!me.loadTask) {
                    me.loadTask = Ext.TaskManager.newTask({
                        run: this.reloadStore,
                        scope: this,
                        interval: 10000
                    });
                }

                me.loadTask.start();

        this.control({
            "combobox#market-select": {
                select: this.onComboboxSelect,
                afterrender: this.onComboboxAfterRender
            },
            "#currenciesGrid": {
                itemclick: this.onViewItemClick
            }
        });
    }

});
